name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Extract subscription ID from Azure credentials
      env:
        AZURE_CREDS: ${{ secrets.AZURE_CREDENTIALS }}
      run: |
        SUBSCRIPTION_ID=$(echo "$AZURE_CREDS" | jq -r '.subscriptionId')
        echo "SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> $GITHUB_ENV

    - name: Extract parameters for resource group creation
      id: extract-params
      run: |
        NAME_PREFIX=$(jq -r '.parameters.namePrefix.value' infra/parameters.json)
        LOCATION=$(jq -r '.parameters.location.value' infra/parameters.json)

        # Validate required parameters
        if [ -z "$NAME_PREFIX" ] || [ "$NAME_PREFIX" = "null" ]; then
          echo "Error: namePrefix is required in parameters.json"
          exit 1
        fi
        if [ -z "$LOCATION" ] || [ "$LOCATION" = "null" ]; then
          echo "Error: location is required in parameters.json"
          exit 1
        fi

        REGISTRY_REPOSITORY=$(jq -r '.parameters.containerRegistryRepository.value // empty' infra/parameters.json 2>/dev/null)
        REGISTRY_SERVER=$(jq -r '.parameters.containerRegistryServer.value // empty' infra/parameters.json 2>/dev/null)
        if [ "$REGISTRY_REPOSITORY" = "null" ]; then
          REGISTRY_REPOSITORY=""
        fi
        if [ -z "$REGISTRY_REPOSITORY" ]; then
          REGISTRY_REPOSITORY="${GITHUB_REPOSITORY}"
          REGISTRY_REPOSITORY=$(echo "$REGISTRY_REPOSITORY" | tr '[:upper:]' '[:lower:]')
        fi
        if [ "$REGISTRY_SERVER" = "null" ] || [ -z "$REGISTRY_SERVER" ]; then
          REGISTRY_SERVER="ghcr.io"
        fi

        IMAGE_NAME="${NAME_PREFIX}-app"

        echo "name-prefix=$NAME_PREFIX" >> $GITHUB_OUTPUT
        echo "location=$LOCATION" >> $GITHUB_OUTPUT
        echo "resource-group=rg-${NAME_PREFIX}" >> $GITHUB_OUTPUT
        echo "container-registry-repository=$REGISTRY_REPOSITORY" >> $GITHUB_OUTPUT
        echo "container-registry-server=$REGISTRY_SERVER" >> $GITHUB_OUTPUT
        echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ steps.extract-params.outputs.resource-group }} \
          --location ${{ steps.extract-params.outputs.location }}

    - name: Create secrets JSON from app secrets
      env:
        APP_SECRETS_JSON: ${{ secrets.APP_SECRETS }}
      run: |
        if [ -z "$APP_SECRETS_JSON" ]; then
          echo "Error: APP_SECRETS secret is not set"
          exit 1
        fi
        echo "$APP_SECRETS_JSON" > infra/secrets.json

        # Validate JSON structure
        if ! jq -e '.googleClientId' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'googleClientId'"
          exit 1
        fi
        if ! jq -e '.googleClientSecret' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'googleClientSecret'"
          exit 1
        fi
        if ! jq -e '.initialUserEmail' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'initialUserEmail'"
          exit 1
        fi
        if ! jq -e '.mongoAdminPassword' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'mongoAdminPassword'"
          exit 1
        fi
        if ! jq -e '.gitSettings.authorName' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'gitSettings.authorName'"
          exit 1
        fi
        if ! jq -e '.gitSettings.authorEmail' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'gitSettings.authorEmail'"
          exit 1
        fi
        if ! jq -e '.gitSettings.token' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'gitSettings.token'"
          exit 1
        fi
        if ! jq -e '.gitSettings.cloneUrl' infra/secrets.json > /dev/null; then
          echo "Error: APP_SECRETS must contain 'gitSettings.cloneUrl'"
          exit 1
        fi
        echo "All required secrets validated"

    - name: Extract secrets for Bicep parameters
      id: extract-secrets
      env:
        APP_SECRETS_JSON: ${{ secrets.APP_SECRETS }}
      run: |
        echo "google-client-id=$(echo "$APP_SECRETS_JSON" | jq -r '.googleClientId')" >> $GITHUB_OUTPUT
        echo "google-client-secret=$(echo "$APP_SECRETS_JSON" | jq -r '.googleClientSecret')" >> $GITHUB_OUTPUT
        echo "initial-user-email=$(echo "$APP_SECRETS_JSON" | jq -r '.initialUserEmail')" >> $GITHUB_OUTPUT
        echo "mongo-admin-password=$(echo "$APP_SECRETS_JSON" | jq -r '.mongoAdminPassword')" >> $GITHUB_OUTPUT
        echo "git-author-name=$(echo "$APP_SECRETS_JSON" | jq -r '.gitSettings.authorName')" >> $GITHUB_OUTPUT
        echo "git-author-email=$(echo "$APP_SECRETS_JSON" | jq -r '.gitSettings.authorEmail')" >> $GITHUB_OUTPUT
        echo "git-token=$(echo "$APP_SECRETS_JSON" | jq -r '.gitSettings.token')" >> $GITHUB_OUTPUT
        echo "git-clone-url=$(echo "$APP_SECRETS_JSON" | jq -r '.gitSettings.cloneUrl')" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      run: |
        docker build -f FestivalManagementWeb/Dockerfile -t ${{ steps.extract-params.outputs.image-name }}:${{ github.sha }} .

    - name: Login to container registry
      run: |
        REGISTRY="${{ steps.extract-params.outputs.container-registry-server }}"
        if [ "$REGISTRY" = "ghcr.io" ]; then
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login "$REGISTRY" --username "${{ github.actor }}" --password-stdin
        else
          echo "Error: Only GHCR (ghcr.io) is supported as container registry"
          exit 1
        fi

    - name: Push Docker image
      run: |
        REPOSITORY="${{ steps.extract-params.outputs.container-registry-repository }}"
        REGISTRY="${{ steps.extract-params.outputs.container-registry-server }}"
        TARGET_IMAGE="$REGISTRY/$REPOSITORY"
        docker tag ${{ steps.extract-params.outputs.image-name }}:${{ github.sha }} $TARGET_IMAGE:${{ github.sha }}
        docker tag ${{ steps.extract-params.outputs.image-name }}:${{ github.sha }} $TARGET_IMAGE:latest
        docker push $TARGET_IMAGE:${{ github.sha }}
        docker push $TARGET_IMAGE:latest

    - name: Deploy Bicep template
      id: deploy-infra
      run: |
        DEPLOYMENT_NAME="deploy-$(date +%s)"

        echo "Starting deployment: $DEPLOYMENT_NAME"

        # Start deployment without waiting
        az deployment group create \
          --name "$DEPLOYMENT_NAME" \
          --resource-group ${{ steps.extract-params.outputs.resource-group }} \
          --template-file infra/main.bicep \
          --parameters @infra/parameters.json \
          --parameters containerRegistryServer="${{ steps.extract-params.outputs.container-registry-server }}" \
          --parameters containerRegistryRepository="${{ steps.extract-params.outputs.container-registry-repository }}" \
          --parameters googleClientId="${{ steps.extract-secrets.outputs.google-client-id }}" \
          --parameters googleClientSecret="${{ steps.extract-secrets.outputs.google-client-secret }}" \
          --parameters initialUserEmail="${{ steps.extract-secrets.outputs.initial-user-email }}" \
          --parameters mongoAdminPassword="${{ steps.extract-secrets.outputs.mongo-admin-password }}" \
          --parameters gitAuthorName="${{ steps.extract-secrets.outputs.git-author-name }}" \
          --parameters gitAuthorEmail="${{ steps.extract-secrets.outputs.git-author-email }}" \
          --parameters gitToken="${{ steps.extract-secrets.outputs.git-token }}" \
          --parameters gitCloneUrl="${{ steps.extract-secrets.outputs.git-clone-url }}" \
          --no-wait

        echo "Deployment started, waiting for completion..."

        # Poll for completion
        while true; do
          STATE=$(az deployment group show \
            --name "$DEPLOYMENT_NAME" \
            --resource-group ${{ steps.extract-params.outputs.resource-group }} \
            --query 'properties.provisioningState' \
            --output tsv 2>/dev/null || echo "NotFound")

          echo "Deployment state: $STATE"

          if [ "$STATE" = "Succeeded" ]; then
            echo "Deployment succeeded!"
            break
          elif [ "$STATE" = "Failed" ] || [ "$STATE" = "Canceled" ]; then
            echo "Deployment failed with state: $STATE"
            az deployment operation group list \
              --name "$DEPLOYMENT_NAME" \
              --resource-group ${{ steps.extract-params.outputs.resource-group }} \
              --query "[?properties.provisioningState=='Failed'].{Resource:properties.targetResource.resourceName, Error:properties.statusMessage}" \
              --output table
            exit 1
          fi

          sleep 15
        done

        # Get outputs in separate command
        CONTAINER_APP_URL=$(az deployment group show \
          --name "$DEPLOYMENT_NAME" \
          --resource-group ${{ steps.extract-params.outputs.resource-group }} \
          --query 'properties.outputs.containerAppUrl.value' \
          --output tsv)

        PRINCIPAL_ID=$(az deployment group show \
          --name "$DEPLOYMENT_NAME" \
          --resource-group ${{ steps.extract-params.outputs.resource-group }} \
          --query 'properties.outputs.containerAppPrincipalId.value' \
          --output tsv)

        echo "containerAppUrl=$CONTAINER_APP_URL" >> $GITHUB_OUTPUT
        echo "principalId=$PRINCIPAL_ID" >> $GITHUB_OUTPUT

    - name: Assign roles to Container App managed identity
      continue-on-error: true
      run: |
        PRINCIPAL_ID="${{ steps.deploy-infra.outputs.principalId }}"
        RESOURCE_GROUP="${{ steps.extract-params.outputs.resource-group }}"

        if [ -z "$PRINCIPAL_ID" ] || [ "$PRINCIPAL_ID" = "null" ]; then
          echo "Warning: Principal ID not found, skipping role assignments"
          exit 0
        fi

        echo "Waiting for managed identity to propagate..."
        sleep 30

        echo "Assigning Reader role..."
        az role assignment create \
          --assignee "$PRINCIPAL_ID" \
          --role "Reader" \
          --scope "/subscriptions/${{ env.SUBSCRIPTION_ID }}/resourceGroups/$RESOURCE_GROUP" \
          2>&1 | grep -v "already exists" || true

        echo "Assigning Monitoring Reader role..."
        az role assignment create \
          --assignee "$PRINCIPAL_ID" \
          --role "Monitoring Reader" \
          --scope "/subscriptions/${{ env.SUBSCRIPTION_ID }}/resourceGroups/$RESOURCE_GROUP" \
          2>&1 | grep -v "already exists" || true

        echo "Assigning Cost Management Reader role..."
        az role assignment create \
          --assignee "$PRINCIPAL_ID" \
          --role "Cost Management Reader" \
          --scope "/subscriptions/${{ env.SUBSCRIPTION_ID }}" \
          2>&1 | grep -v "already exists" || true

        echo "Role assignments completed"

    - name: Cleanup secrets
      if: always()
      run: rm -f infra/secrets.json

    - name: Output application URL
      run: |
        echo "Application deployed to: ${{ steps.deploy-infra.outputs.containerAppUrl }}"

