@using System
@model FestivalManagementWeb.Models.CosmosCapacityViewModel
@{
    ViewData["Title"] = "Cosmos 容量制限";
    var cosmos = Model.Cosmos;
    var storageDisplay = cosmos.StorageGb.HasValue ? $"{cosmos.StorageGb.Value:F2} GB" : "取得中";
    var limitDisplay = cosmos.FreeTierStorageLimitGb > 0 ? $"{cosmos.FreeTierStorageLimitGb:F2} GB" : "未設定";
    var percentDisplay = cosmos.StoragePercentOfLimit.HasValue ? $"{cosmos.StoragePercentOfLimit.Value:F1}%" : "-";
    var ruDisplay = cosmos.Provisioning == FestivalManagementWeb.Models.CosmosProvisioningModel.RequestUnits
        ? (cosmos.ProvisionedRu.HasValue ? $"{cosmos.ProvisionedRu.Value:F0} RU/s" : "取得中")
        : "対象外";
    var years = Model.AvailableYears ?? Array.Empty<int>();
}
<div class="container py-4">
    <h1 class="mb-3">Cosmos DB 容量制限</h1>
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Cosmos DB の無料枠を超過しました。</h4>
        <p class="mb-1">保存容量が無料枠上限に到達したため、新しいデータの登録・更新はブロックされています。</p>
        <p class="mb-0">不要なデータを削除するか、Cosmos DB のプランを拡張してから再試行してください。</p>
    </div>
    <div class="card mb-4">
        <div class="card-header">現在の Cosmos DB 使用状況</div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">プロビジョニング モデル</dt>
                <dd class="col-sm-8">@cosmos.Provisioning</dd>
                <dt class="col-sm-4">保存容量</dt>
                <dd class="col-sm-8">@storageDisplay / @limitDisplay (@percentDisplay)</dd>
                <dt class="col-sm-4">RU スループット</dt>
                <dd class="col-sm-8">@ruDisplay</dd>
                <dt class="col-sm-4">無料枠設定</dt>
                <dd class="col-sm-8">
                    @(cosmos.FreeTierActive == true ? "有効" : cosmos.FreeTierActive == false ? "無効" : "不明")
                </dd>
                <dt class="col-sm-4">最終更新</dt>
                <dd class="col-sm-8">@(cosmos.CheckedAtUtc?.ToLocalTime().ToString("yyyy/MM/dd HH:mm") ?? "取得中")</dd>
            </dl>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header">対応方法</div>
        <div class="card-body">
            <ul class="mb-3">
                <li>不要になったテキスト／画像データを削除して空き容量を確保する。</li>
                <li>Cosmos DB アカウントの容量を拡張する、または有料プランへ切り替える。</li>
                <li>Azure Portal でバックアップやアーカイブを実施し、低頻度データを別ストレージへ移行する。</li>
            </ul>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-primary" asp-controller="TextKeyValues" asp-action="Index">テキストデータ管理へ</a>
                <a class="btn btn-outline-primary" asp-controller="ImageKeyValues" asp-action="Index">画像データ管理へ</a>
                <a class="btn btn-outline-secondary" href="https://portal.azure.com/" target="_blank" rel="noopener">Azure Portal を開く</a>
            </div>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(Model.CleanupMessage))
    {
        <div class="alert alert-info">@Model.CleanupMessage</div>
    }
    <div class="card mb-4">
        <div class="card-header">年度別データ削除 (Cosmos DB for MongoDB)</div>
        <div class="card-body">
            <p class="text-muted small mb-3">対象の年度を選択して削除すると、Cosmos DB for MongoDB に保存されている該当年度のデータが消去されます。画像データを削除すると関連する GridFS バイナリも削除されます。</p>
            @if (years.Count == 0)
            {
                <p class="mb-0">削除可能な年度のデータはありません。</p>
            }
            else
            {
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-lg-6">
                        <form asp-action="DeleteTextYear" method="post" class="row g-2 align-items-end">
                            <div class="col-12 col-sm-auto">
                                <label class="form-label" for="textYear">年度</label>
                                <select class="form-select" id="textYear" name="year" required>
                                    @foreach (var year in years)
                                    {
                                        <option value="@year">@year 年</option>
                                    }
                                </select>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-danger">テキストデータを削除</button>
                            </div>
                        </form>
                    </div>
                    <div class="col-12 col-lg-6">
                        <form asp-action="DeleteImageYear" method="post" class="row g-2 align-items-end">
                            <div class="col-12 col-sm-auto">
                                <label class="form-label" for="imageYear">年度</label>
                                <select class="form-select" id="imageYear" name="year" required>
                                    @foreach (var year in years)
                                    {
                                        <option value="@year">@year 年</option>
                                    }
                                </select>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-warning">画像データを削除</button>
                            </div>
                        </form>
                    </div>
                </div>
                <p class="text-danger small mt-3 mb-0">※ 削除は取り消せません。必要に応じてバックアップを取得してから実行してください。</p>
            }
        </div>
    </div>
    <a class="btn btn-link" asp-controller="Home" asp-action="Index">ダッシュボードへ戻る</a>
</div>

